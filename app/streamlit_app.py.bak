from pathlib import Path

import pandas as pd
import streamlit as st

from ebay_price.features.align import align_to_columns
from ebay_price.features.inference import build_inference_features
from ebay_price.modeling.loaders import load_reg_model_and_columns

ART_DIR = Path("data/artifacts/models")


# ---------- UI SECTIONS ----------
def render_predict() -> None:
    st.caption(
        f"Using model: {(ART_DIR / ('reg_lightgbm.joblib' if (ART_DIR / 'reg_lightgbm.joblib').exists() else 'reg_linear.joblib')).name}"
    )

    st.header("Listing")
    with st.form("predict_form"):
        title = st.text_input("Title", value="Apple iPhone 12 128GB")
        brand = st.selectbox("Brand", ["Apple", "Samsung", "Google", "OnePlus"], index=0)
        model = st.selectbox(
            "Model", ["iPhone 12", "iPhone 13", "Galaxy S21", "Pixel 6", "OnePlus 9"], index=0
        )
        category_path = st.text_input(
            "Category Path", "Cell Phones & Accessories > Cell Phones & Smartphones"
        )
        condition = st.selectbox("Condition", ["Used", "Refurbished", "New"], index=0)
        start_price = st.number_input(
            "Start Price", min_value=0.0, value=250.0, step=5.0, format="%.2f"
        )
        shipping_cost = st.number_input(
            "Shipping Cost", min_value=0.0, value=10.0, step=1.0, format="%.2f"
        )
        watchers = st.number_input("Watchers", min_value=0, value=15, step=1)
        bids = st.number_input("Bids", min_value=0, value=12, step=1)

        submitted = st.form_submit_button("Predict price")
        if submitted:
            payload = {
                "title": title,
                "brand": brand,
                "model": model,
                "category_path": category_path,
                "condition": condition,
                "start_price": start_price,
                "shipping_cost": shipping_cost,
                "watchers": watchers,
                "bids": bids,
            }
            X = build_inference_features(pd.DataFrame([payload]))
            model, cols, mname = load_reg_model_and_columns()
            if cols:
                X = align_to_columns(X, cols)
            # Keep pandas DataFrame (no feature-name warning)
            pred = float(model.predict(X.to_pandas().fillna(0))[0])
            st.caption(f"Using model: {mname}")
            st.success(f"Predicted price: ${pred:,.2f}")


def render_insights() -> None:
    st.header("Model Insights")

    plots = Path("data/artifacts/plots")
    perm_csv = plots / "perm_importance.csv"
    nat_csv = plots / "native_importance.csv"
    shap_img = plots / "shap_summary.png"
    pd_imgs = sorted(plots.glob("pd_ice_*.png"))

    if perm_csv.exists():
        st.subheader("Permutation importance")
        st.dataframe(pd.read_csv(perm_csv).head(30))
    else:
        st.info("Run `make explain` to compute insights.")

    if nat_csv.exists():
        st.subheader("Native feature importance")
        st.dataframe(pd.read_csv(nat_csv).head(30))

    if shap_img.exists():
        st.subheader("SHAP summary")
        st.image(str(shap_img), width="stretch")

    st.subheader("Partial Dependence / ICE")
    if pd_imgs:
        for im in pd_imgs:
            st.image(str(im), caption=im.name, width="stretch")
    else:
        st.caption("No PD/ICE plots yet. Run `make explain`.")


# ---------- PAGE ----------
st.set_page_config(page_title="eBay Price Prediction", page_icon="ðŸ“ˆ", layout="wide")
st.title("eBay Price Prediction")
tabs = st.tabs(["Predict", "Insights"])
with tabs[0]:
    render_predict()
with tabs[1]:
    render_insights()
